# Database Schema

The app uses PostgreSQL via Drizzle ORM. All tables are defined in `shared/schema.ts`.

## Tables

### `war_events`

Stores individual security events (missile launches, interceptions, alerts, etc.).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `varchar` | Primary Key | UUID generated by `randomUUID()` |
| `type` | `varchar(50)` | Not Null | One of: `missile_launch`, `missile_intercept`, `missile_hit`, `drone_launch`, `drone_intercept`, `air_raid_alert`, `ceasefire`, `military_operation`, `explosion`, `sirens` |
| `title` | `text` | Not Null | Short event headline |
| `description` | `text` | Not Null | Detailed event description |
| `location` | `text` | Not Null | Human-readable location name |
| `lat` | `real` | Not Null | Latitude coordinate |
| `lng` | `real` | Not Null | Longitude coordinate |
| `country` | `varchar(100)` | Not Null | Country name (Iran, Israel, Lebanon, etc.) |
| `source` | `varchar(200)` | Not Null | Attribution (IDF Spokesperson, CENTCOM, Reuters, etc.) |
| `timestamp` | `text` | Not Null | ISO 8601 timestamp string |
| `threatLevel` | `varchar(20)` | Not Null | One of: `critical`, `high`, `medium`, `low` |
| `verified` | `boolean` | Not Null, Default: false | Whether the event is confirmed |

Auto-cleanup: The storage layer automatically prunes events beyond 500 total, keeping the newest.

### `news_items`

News headlines and articles.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `varchar` | Primary Key | UUID |
| `title` | `text` | Not Null | Headline text |
| `source` | `varchar(200)` | Not Null | News source (Reuters, Al Jazeera, etc.) |
| `timestamp` | `text` | Not Null | ISO 8601 timestamp |
| `url` | `text` | Nullable | Link to original article |
| `category` | `varchar(100)` | Not Null | Category: Military, Diplomacy, Defense, etc. |
| `breaking` | `boolean` | Not Null, Default: false | Whether this is breaking news |

### `alerts`

Pikud HaOref (Israel Home Front Command) alerts and sirens.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `varchar` | Primary Key | UUID |
| `area` | `text` | Not Null | Affected area (e.g., "Tel Aviv - Gush Dan") |
| `threat` | `text` | Not Null | Threat description (e.g., "Missile threat - enter shelters immediately") |
| `timestamp` | `text` | Not Null | ISO 8601 timestamp |
| `active` | `boolean` | Not Null, Default: true | Whether alert is currently active |
| `lat` | `real` | Not Null | Latitude of affected area |
| `lng` | `real` | Not Null | Longitude of affected area |

### `ai_summaries`

AI-generated situation analysis reports.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `serial` | Primary Key | Auto-incrementing integer |
| `summary` | `text` | Not Null | Full situation assessment paragraph |
| `threatAssessment` | `varchar(20)` | Not Null | Overall threat level: `critical`, `high`, `medium`, `low` |
| `keyPoints` | `jsonb` | Not Null | Array of string bullet points |
| `lastUpdated` | `text` | Not Null | ISO 8601 timestamp of last update |
| `recommendation` | `text` | Not Null | Recommended actions for civilians |

### `data_source_status`

Tracks health and configuration of external data fetcher sources.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `varchar` | Primary Key | Source identifier |
| `name` | `varchar(100)` | Not Null | Human-readable source name |
| `lastFetchedAt` | `text` | Nullable | Last fetch attempt timestamp |
| `lastSuccessAt` | `text` | Nullable | Last successful fetch timestamp |
| `lastError` | `text` | Nullable | Last error message |
| `enabled` | `boolean` | Not Null, Default: true | Whether source is active |
| `fetchIntervalSeconds` | `serial` | Not Null | Polling interval |

## Zod Validation Schemas

Defined in `shared/schema.ts` alongside the Drizzle tables:

- `eventSchema` - Validates `WarEvent` objects with enum checks for `type` and `threatLevel`
- `newsItemSchema` - Validates news items (optional `url`)
- `alertSchema` - Validates alerts including coordinates
- `aiSummarySchema` - Validates summaries with `keyPoints` array and threat enum
- `statisticsSchema` - Validates computed statistics (not a table; calculated in-memory)

Insert schemas (generated by `drizzle-zod`):
- `insertWarEventSchema`
- `insertNewsItemSchema`
- `insertAlertSchema`
- `insertAiSummarySchema` (omits auto-generated `id`)
- `insertDataSourceStatusSchema`

## Statistics (Computed, Not Stored)

The `Statistics` type is not a database table. It is calculated on-the-fly by `DatabaseStorage.getStatistics()` by aggregating data from `war_events`:

```typescript
interface Statistics {
  totalLaunches: number;
  totalInterceptions: number;
  totalHits: number;
  interceptionRate: number;
  activeAlerts: number;
  totalDrones: number;
  droneInterceptions: number;
  byCountry: Record<string, { launches: number; interceptions: number }>;
  bySystem: {
    ironDome: number;
    arrowSystem: number;
    davidsSling: number;
    thaad: number;
  };
}
```

The `bySystem` breakdown is derived from event descriptions by keyword matching (e.g., "Iron Dome" in the description maps to `ironDome`).

## Database Seeding

On first startup, `server/seed.ts` checks if the database is empty and populates it with:
- 15 war events (missile launches, interceptions, drone activity, alerts, explosions)
- 12 news items (military, diplomacy, defense, infrastructure)
- 6 alerts (3 active, 3 inactive)

The AI summary is generated on-demand by the storage layer if none exists.

## Schema Modifications

When modifying the schema in `shared/schema.ts`:
1. Update the Drizzle table definition
2. Update the corresponding Zod schema
3. Update the `IStorage` interface in `server/storage.ts` if adding new CRUD operations
4. Run `npm run db:push` to sync the schema to PostgreSQL
5. Never manually write SQL migrations
